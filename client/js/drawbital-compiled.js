function drawToCtx(e,t){var a;e.clearRect(0,0,canvas.width,canvas.height);for(var o=0;o<t.actionList.length;o++)if(!t.actionList[o].deleted)if(a=t.actionList[o].points,"text"===t.actionList[o].tool)e.font=t.actionList[o].size+"px sans-serif",e.fillStyle=t.actionList[o].colour,e.fillText(t.actionList[o].text,a[0][0],a[0][1]);else{e.lineJoin="round",e.lineCap="round",e.strokeStyle=t.actionList[o].colour,e.lineWidth=t.actionList[o].size,e.beginPath(),e.moveTo(a[0][0],a[0][1]-.01);for(var i=1;i<a.length;i++)a[i][0]>0&&e.lineTo(a[i][0],a[i][1]);e.stroke()}}function drawToCtxRealtime(e,t){e.lineJoin="round",e.lineCap="round",e.clearRect(0,0,canvas.width,canvas.height);for(var a in t.publicPathMap)if(e.strokeStyle=t.clientColours[a],e.lineWidth=t.clientSizes[a],t.publicPathMap[a][0]){e.beginPath(),e.moveTo(t.publicPathMap[a][0][0],t.publicPathMap[a][0][1]);for(var o=1;o<t.publicPathMap[a].length;o++)e.lineTo(t.publicPathMap[a][o][0],t.publicPathMap[a][o][1]);e.stroke()}}function changeTool(e){curTool=e,socket.emit("changeTool",{toolName:e}),"text"===curTool&&cursorCtx.clearRect(0,0,canvas.width,canvas.height)}function zoom(e){scale+e>=.2&&scale+e<=3&&(scale+=e)}function getMousePos(e,t){var a=viewCanvas.getBoundingClientRect();return{x:(t.clientX-a.left+viewX*scale)/scale,y:(t.clientY-a.top+viewY*scale)/scale}}function dragMove(e,t){rightMousedown&&mousemove&&(viewX-(e-rMouseX)>0&&viewX-(e-rMouseX)<canvas.width-viewCanvas.width/scale&&(viewX-=e-rMouseX),viewY-(t-rMouseY)>0&&viewY-(t-rMouseY)<canvas.height-viewCanvas.height/scale&&(viewY-=t-rMouseY))}function drawPublicCursors(e){for(var t in e.colour)socket.id!=t&&(cursorCtx.fillStyle=e.colour[t],cursorCtx.lineWidth=1,cursorCtx.beginPath(),cursorCtx.arc(e.position[t][0],e.position[t][1],e.size[t]/2,0,2*Math.PI,!0),cursorCtx.closePath());cursorCtx.fill(),labelCursors(e)}function labelCursors(e){cursorCtx.lineWidth=.8,cursorCtx.font="15pt Calibri",cursorCtx.textAlign="center",cursorCtx.fillStyle="white",cursorCtx.strokeStyle="black";for(var t in e.colour)socket.id!=t&&(cursorCtx.fillText(e.name[t],e.position[t][0],e.position[t][1]+e.size[t]/2+15),cursorCtx.strokeText(e.name[t],e.position[t][0],e.position[t][1]+e.size[t]/2+15))}function drawLocalCursor(e,t){cursorCtx.fillStyle=curColour,cursorCtx.lineWidth=1,cursorCtx.beginPath(),cursorCtx.arc(e,t,curSize/2,0,2*Math.PI,!0),cursorCtx.closePath(),cursorCtx.fill()}function drawCursors(){cursorCtx.clearRect(0,0,canvas.width,canvas.height),drawPublicCursors(cursorData),"brush"==curTool&&drawLocalCursor(mouseX,mouseY)}function resize(){viewCanvas.width=window.innerWidth-400,viewCanvas.height=window.innerHeight-250,chatDiv.style.height=viewCanvas.height+"px"}function repeat(){viewCtx.fillStyle="white",viewCtx.fillRect(0,0,viewCanvas.width,viewCanvas.height),drawAll(mouseX,mouseY),dragMove(mouseX,mouseY),translateAll(),drawZoomed(),requestAnimationFrame(repeat)}function drawAll(e,t){serverDrawn||(drawToCtx(serverCtx,serverData),serverDrawn=!0),publicDrawn||(drawToCtxRealtime(ctx,publicData),publicDrawn=!0),permDrawn||(drawToCtx(permCtx,permData),permDrawn=!0),cursorDrawn||(drawCursors(),cursorDrawn=!0)}function drawZoomed(){viewCtx.save(),viewCtx.scale(scale,scale),viewCtx.drawImage(permCanvas,viewX,viewY,viewCanvas.width/scale,viewCanvas.height/scale,0,0,viewCanvas.width/scale,viewCanvas.height/scale),viewCtx.drawImage(serverCanvas,viewX,viewY,viewCanvas.width/scale,viewCanvas.height/scale,0,0,viewCanvas.width/scale,viewCanvas.height/scale),viewCtx.drawImage(cursorLayer,viewX,viewY,viewCanvas.width/scale,viewCanvas.height/scale,0,0,viewCanvas.width/scale,viewCanvas.height/scale),viewCtx.drawImage(canvas,viewX,viewY,viewCanvas.width/scale,viewCanvas.height/scale,0,0,viewCanvas.width/scale,viewCanvas.height/scale),viewCtx.restore()}function translateAll(){keyStates.W&&viewY>0&&(viewY-=PANNING_SPEED),keyStates.D&&viewX+viewCanvas.width<canvas.width&&(viewX+=PANNING_SPEED),keyStates.S&&viewY+viewCanvas.height<canvas.height&&(viewY+=PANNING_SPEED),keyStates.A&&viewX>0&&(viewX-=PANNING_SPEED)}function generateCanvasImage(){var e=document.createElement("canvas"),t=e.getContext("2d");e.width=canvas.width,e.height=canvas.height,t.fillStyle="white",t.fillRect(0,0,e.width,e.height),t.drawImage(permCanvas,0,0),t.drawImage(serverCanvas,0,0);var a=document.getElementById("link");a.setAttribute("download","canvasImage.png"),a.setAttribute("href",e.toDataURL("image/png").replace("image/png","image/octet-stream")),a.click()}function clearChatUser(){for(;chatText.firstChild;)chatText.removeChild(chatText.firstChild);for(;userList.firstChild;)userList.removeChild(userList.firstChild)}function drawTimer(e,t){timerCtx.save(),timerCtx.translate(timerCanvas.width/2,timerCanvas.height/2),timerCtx.rotate(.5*Math.PI),timerCtx.scale(-1,1),timerCtx.translate(-timerCanvas.width/2,-timerCanvas.height/2),timerCtx.clearRect(0,0,timerCanvas.width,timerCanvas.height),timerCtx.beginPath(),timerCtx.arc(timerCanvas.width/2,timerCanvas.height/2,timerCanvas.height/2-3,0,2*Math.PI),timerCtx.stroke(),timerCtx.closePath(),timerCtx.beginPath(),timerCtx.moveTo(timerCanvas.width/2,timerCanvas.height/2),timerCtx.arc(timerCanvas.width/2,timerCanvas.height/2,timerCanvas.height/2-5,0,e/t*2*Math.PI),timerCtx.lineTo(timerCanvas.width/2,timerCanvas.height/2),timerCtx.closePath(),timerCtx.fillStyle=e/t<=.167?"red":"blue",timerCtx.fill(),timerCtx.stroke(),timerCtx.restore()}function gotoLobby(){$("#lobby-li").attr("class","active"),$("#draw-li").removeAttr("class"),signInDiv.style.display="none",lobbyDiv.style.display="inline",displayDiv.style.display="none",transitionBackground(LOBBY_BG_COLOUR)}function gotoDraw(){$("#draw-li").attr("class","active"),$("#lobby-li").removeAttr("class"),lobbyDiv.style.display="none",signInDiv.style.display="none",displayDiv.style.display="inline-block",transitionBackground(DRAW_BG_COLOUR)}function gotoSignin(){$("#draw-li").removeAttr("class"),$("#lobby-li").removeAttr("class"),lobbyDiv.style.display="none",signInDiv.style.display="inline-block",displayDiv.style.display="none",transitionBackground(SIGNIN_BG_COLOUR)}function transitionBackground(e){document.body.style.background=e,document.body.style.backgroundImage="url(/client/img/bg-pattern.png)"}function showSnackBar(e,t){$.notify(e,{type:t})}var canvas=document.getElementById("publicSurface"),ctx=canvas.getContext("2d"),serverCanvas=document.getElementById("serverSurface"),serverCtx=serverSurface.getContext("2d"),permCanvas=document.getElementById("permanentSurface"),permCtx=permCanvas.getContext("2d"),cursorLayer=document.getElementById("cursorLayer"),cursorCtx=cursorLayer.getContext("2d"),viewCanvas=document.getElementById("view"),viewCtx=viewCanvas.getContext("2d"),CANVAS_WIDTH=3500,CANVAS_HEIGHT=3500,looping=!1,canvasArray=[canvas,serverCanvas,cursorLayer,permCanvas],curColour="#000000",curTool="brush",curSize=5,socket=io(),PANNING_SPEED=10,scale=1,ZOOM_STEP=20,serverData,publicData,permData,cursorData,serverDrawn=!0,publicDrawn=!0,permDrawn=!0;cursorDrawn=!0;for(var timerPanel=document.getElementById("timerPanel"),mousedown=!1,rightMousedown=!1,rMouseX,rMouseY,mouseX,mouseY,mousemove=!1,viewX=0,viewY=0,i=0;i<canvasArray.length;i++)canvasArray[i].width=CANVAS_WIDTH,canvasArray[i].height=CANVAS_HEIGHT;$(document).ready(function(){$("#full").spectrum({color:"#000000",showInput:!0,className:"full-spectrum",showInitial:!0,showPalette:!0,showSelectionPalette:!0,maxSelectionSize:20,preferredFormat:"hex",localStorageKey:"spectrum.drawbital",showAlpha:!0,move:function(e){curColour=e.toRgbString(),socket.emit("colour",{value:e.toRgbString()})},palette:[["#000","#444","#666","#999","#ccc","#eee","#f3f3f3","#fff"],["#f00","#f90","#ff0","#0f0","#0ff","#00f","#90f","#f0f"],["#f4cccc","#fce5cd","#fff2cc","#d9ead3","#d0e0e3","#cfe2f3","#d9d2e9","#ead1dc"],["#ea9999","#f9cb9c","#ffe599","#b6d7a8","#a2c4c9","#9fc5e8","#b4a7d6","#d5a6bd"],["#e06666","#f6b26b","#ffd966","#93c47d","#76a5af","#6fa8dc","#8e7cc3","#c27ba0"],["#c00","#e69138","#f1c232","#6aa84f","#45818e","#3d85c6","#674ea7","#a64d79"],["#900","#b45f06","#bf9000","#38761d","#134f5c","#0b5394","#351c75","#741b47"],["#600","#783f04","#7f6000","#274e13","#0c343d","#073763","#20124d","#4c1130"]]}),resize(),viewX=canvas.width/2-viewCanvas.width/2,viewY=canvas.height/2-viewCanvas.height/2}),socket.on("drawServerData",function(e){serverData=e,serverDrawn=!1}),socket.on("drawPublicData",function(e){publicData=e,publicDrawn=!1}),socket.on("drawCursorData",function(e){cursorData=e,cursorDrawn=!1}),socket.on("drawPermData",function(e){permData=e,permDrawn=!1}),socket.on("joinStatus",function(e){e.value&&(displayDiv.style.display="inline-block","game"==e.roomMode?timerPanel.style.display="inline":timerPanel.style.display="none",looping||(repeat(),looping=!0))}),document.getElementById("clearBtn").onclick=function(){socket.emit("clear")},socket.on("clear",function(){serverCtx.clearRect(0,0,canvas.width,canvas.height),permCtx.clearRect(0,0,canvas.width,canvas.height)}),document.getElementById("brushBtn").onclick=function(){changeTool("brush")},document.getElementById("textBtn").onclick=function(){changeTool("text")},document.getElementById("undoBtn").onclick=function(){socket.emit("undo")},document.getElementById("redoBtn").onclick=function(){socket.emit("redo")},document.getElementById("zoomOutBtn").onclick=function(){zoom(-.1)},document.getElementById("resetZoomBtn").onclick=function(){scale=1},document.getElementById("zoomInBtn").onclick=function(){zoom(.1)},viewCanvas.onmousedown=function(e){var t=getMousePos(viewCanvas,e);posx=mouseX=t.x,posy=mouseY=t.y,document.onselectstart=function(){return!1},0==e.button&&(mousedown=!0,"brush"==curTool?socket.emit("keyPress",{inputId:"mousedown",x:posx,y:posy,state:!0}):"text"==curTool&&socket.emit("drawText",{x:posx,y:posy,text:prompt("Enter text:","")})),2==e.button&&(viewCanvas.style.cursor="move",rMouseX=t.x,rMouseY=t.y,rightMousedown=!0)},viewCanvas.onmousemove=function(e){mousemove=!0;var t=getMousePos(viewCanvas,e);posx=mouseX=t.x,posy=mouseY=t.y,socket.emit("keyPress",{inputId:"mousemove",x:posx,y:posy,state:!0}),cursorDrawn=!1},viewCanvas.oncontextmenu=function(e){return!1},$("#view").mousestop(10,function(){mousemove=!1}),viewCanvas.onmouseup=function(e){document.onselectstart=function(){return!0},0==e.button&&(mousedown=!1,socket.emit("keyPress",{inputId:"mousedown",state:!1})),2==e.button&&(viewCanvas.style.cursor="auto",rightMousedown=!1,rMouseX=void 0,rMouseY=void 0)},viewCanvas.onmouseleave=function(e){mousedown=!1,viewCanvas.style.cursor="auto",rightMousedown=!1,rMouseX=void 0,rMouseY=void 0,socket.emit("keyPress",{inputId:"mousedown",state:!1})},document.getElementById("brushSize").onchange=function(){curSize=brushSize.value,socket.emit("size",{value:brushSize.value})};var keyStates={W:!1,A:!1,S:!1,D:!1};window.onresize=function(){resize()};var chatDiv=document.getElementById("chatDiv");viewCanvas.onmousewheel=function(e){zoom(e.wheelDelta/120/ZOOM_STEP)},viewCanvas.onkeydown=function(e){"W"==String.fromCharCode(e.keyCode)&&(keyStates.W=!0),"A"==String.fromCharCode(e.keyCode)&&(keyStates.A=!0),"S"==String.fromCharCode(e.keyCode)&&(keyStates.S=!0),"D"==String.fromCharCode(e.keyCode)&&(keyStates.D=!0)},viewCanvas.onkeyup=function(e){"W"==String.fromCharCode(e.keyCode)&&(keyStates.W=!1),"A"==String.fromCharCode(e.keyCode)&&(keyStates.A=!1),"S"==String.fromCharCode(e.keyCode)&&(keyStates.S=!1),"D"==String.fromCharCode(e.keyCode)&&(keyStates.D=!1)},$("#saveForm").submit(e=>(socket.emit("saveState",{saveName:$("#saveName").val()},e=>{e.nameExists?showSnackBar("A save with the same name already exists.","danger"):($("#saveModal").modal("hide"),$("#saveName").val(""),showSnackBar("Saved","success"))}),!1)),$("#loadBtn").on("click",e=>{socket.emit("getSaveList")}),socket.on("saveList",e=>{$("#saveList").empty();for(var t in e.saves)$("#saveList").append(`<a id="load${t}" class="list-group-item list-group-item-action" saveName="${e.saves[t]}" href="#">${e.saves[t]}<button type="button" saveName="${e.saves[t]}" class="close" id="delete${t} ">&times;</button></a>`)}),$("#saveList").on("dblclick",".list-group-item",function(){socket.emit("loadState",{idx:this.getAttribute("saveName")},function(e){e?showSnackBar("Save loaded","success"):showSnackBar("Load not allowed in Guessketch","danger")}),$("#loadModal").modal("hide")}),$("#saveList").on("click",".close",function(){socket.emit("deleteSave",{idx:this.getAttribute("saveName")}),$(`#load${this.id.slice(6)}`).remove()}),$("#downloadBtn").on("click",function(){generateCanvasImage()});var chatText=document.getElementById("chat-text"),chatInput=document.getElementById("chat-input"),chatForm=document.getElementById("chat-form"),chatTab=document.getElementById("chatTab"),userTab=document.getElementById("userTab"),userList=document.getElementById("user-list"),userListPanel=document.getElementById("user-list-panel");socket.on("addToChat",function(e){var t=!1;Math.abs(chatText.scrollTop-(chatText.scrollHeight-chatText.offsetHeight))<1&&(t=!0),chatText.innerHTML+="<div>"+e+"</div>",t&&(chatText.scrollTop=chatText.scrollHeight-chatText.offsetHeight)}),socket.on("refreshUserList",function(e){for(;userList.firstChild;)userList.removeChild(userList.firstChild);if(void 0!==e[0])if(e[0].name)for(var t in e)userList.innerHTML+='<li class="list-group-item">'+e[t].name+' <span class="badge">'+e[t].score+"</span></li>";else for(var t in e)userList.innerHTML+='<li class="list-group-item">'+e[t]+"</li>"}),socket.on("connectRoom",function(e){clearChatUser();for(var t in e.chatTextList)chatText.innerHTML+="<div><strong>"+e.chatTextList[t].userName+"</strong>: "+e.chatTextList[t].message+"</div>";chatText.scrollTop=chatText.scrollHeight-chatText.offsetHeight}),socket.on("evalAnswer",function(e){console.log(e)}),chatForm.onsubmit=function(e){e.preventDefault(),"/"===chatInput.value[0]?socket.emit("evalServer",chatInput.value.slice(1)):socket.emit("sendMsgToServer",chatInput.value),chatInput.value=""};var signDiv=document.getElementById("signDiv"),signDivUsername=document.getElementById("signDiv-username"),signDivApply=document.getElementById("signDiv-Apply");$(document).ready(function(){chatText.style.width=chatDiv.style.width,userListPanel.style.width=chatDiv.style.width}),userTab.onclick=function(){chatTab.setAttribute("class",""),userTab.setAttribute("class","active"),chatText.setAttribute("style","display:none;"),userListPanel.setAttribute("style","display:flex;")},chatTab.onclick=function(){userTab.setAttribute("class",""),chatTab.setAttribute("class","active"),chatText.setAttribute("style","display:inline;"),userListPanel.setAttribute("style","display:none;")};var signInDiv=document.getElementById("signInDiv"),lobbyDiv=document.getElementById("lobbyDiv"),loggedIn=!1;$("#login-submit").on("click",()=>(socket.emit("signIn",{username:$("#login-username").val().trim(),password:$("#login-password").val()},e=>(e.loggedIn?showSnackBar("Already logged in","danger"):e.success?(gotoLobby(),loggedIn=!0,$("#login-modal").modal("hide"),$("#user-menu").css("display","inline"),$("#greeting").prepend(`Welcome, ${$("#login-username").val().trim()}`)):showSnackBar("Incorrect username/password","danger"),!1)),!1)),$("#register-submit").on("click",()=>{if($("#register-password").val()!=$("#register-password2").val())showSnackBar("Passwords don't match","danger");else if($("#register-username").val().length<3)showSnackBar("Username should be at least 3 characters long","danger");else{if(!($("#register-password").val().length<3))return socket.emit("signUp",{username:$("#register-username").val().trim(),password:$("#register-password").val()},e=>(e.success?(showSnackBar("Sign up successful","success"),$("#register-modal").modal("hide")):showSnackBar("Sign up unsuccessful, username taken","danger"),!1)),!1;showSnackBar("Password should be at least 3 characters long","danger")}return!1});var roomList=document.getElementById("room-list"),roomNameForm=document.getElementById("room-name"),maxUsersForm=document.getElementById("max-users"),passwordForm=document.getElementById("password"),createBtn=document.getElementById("createBtn"),displayDiv=document.getElementById("displayDiv"),lobbyDiv=document.getElementById("lobbyDiv"),drawRadio=document.getElementById("drawRadio"),gameRadio=document.getElementById("gameRadio"),numRounds=document.getElementById("num-rounds"),roomData,joinedRoom=!1;socket.on("signInResponse",function(e){e.success&&(loggedIn=!0)}),createBtn.onclick=function(){if(roomNameForm.value.trim()&&maxUsersForm.value.trim())return socket.emit("createRoom",{roomName:roomNameForm.value.trim(),maxUsers:maxUsersForm.value.trim(),password:passwordForm.value,creatorId:socket.id,mode:drawRadio.checked?"draw":"game",roundsPerGame:numRounds.value},e=>{e||showSnackBar("A room with the same name already exists","danger")}),clearChatUser(),!1},gameRadio.onclick=function(){$("#num-rounds").removeAttr("disabled")},drawRadio.onclick=function(){$("#num-rounds").attr("disabled","")},socket.on("updateRoomList",function(e){roomData=e,roomList.innerHTML="";for(var t=0;t<e.length;t++)e[t].isPrivate?roomList.innerHTML+='<a id="'+t+'" href="#" class="list-group-item list-group-item-action">'+e[t].roomName+' <span class="badge"><i class="fa fa-user"></i> '+e[t].numUsers+'</span><i class="fa fa-lock"></i></a>':roomList.innerHTML+='<a id="'+t+'" href="#" class="list-group-item list-group-item-action">'+e[t].roomName+'<span class="badge"><i class="fa fa-user"></i> '+e[t].numUsers+"</span></a>"}),socket.on("joinStatus",function(e){e.value?(joinedRoom=!0,gotoDraw()):showSnackBar("Incorrect password","danger")}),$("#room-panel-body").on("dblclick",".list-group-item",function(){var e=roomData[this.id];if(e.numUsers>=e.maxUsers)showSnackBar("Room is full","danger");else{var t;e.isPrivate&&(t=prompt("Enter password","")),socket.emit("joinRoom",{roomNumber:this.id,clientId:socket.id,password:t})}});var timerCanvas=document.getElementById("timerCanvas"),timerCtx=timerCanvas.getContext("2d"),audioNewDrawer=new Audio("./client/audio/you_are_drawer.wav"),audioAnswerFound=new Audio("./client/audio/answer_found.wav"),audioNewRound=new Audio("./client/audio/new_round.wav"),audioWin=new Audio("./client/audio/win.wav"),audioClock=new Audio("./client/audio/clock_ticking.wav"),audioDing=new Audio("./client/audio/ding.wav");timerCanvas.width=timerCanvas.height=50,socket.on("playAudio",function(e){switch(e.track){case"newDrawer":audioNewDrawer.play();break;case"answerFound":audioAnswerFound.play();break;case"newRound":audioNewRound.play();break;case"win":audioWin.play();break;case"clock":audioClock.play();break;case"ding":audioDing.play()}}),socket.on("stopAudio",function(e){switch(e.track){case"newDrawer":audioNewDrawer.pause(),audioNewDrawer.load();break;case"answerFound":audioAnswerFound.pause(),audioAnswerFound.load();break;case"newRound":audioNewRound.pause(),audioNewRound.load();break;case"win":audioWin.pause(),audioWin.load();break;case"clock":audioClock.pause(),audioClock.load();break;case"ding":audioDing.pause(),audioDing.load()}}),socket.on("gameTimer",function(e){$("#timerText").replaceWith(""),drawTimer(e.timer,60)}),socket.on("gameHint",function(e){""==e.hint?$("#hintText").replaceWith("<h4 id='hintText'></h4>"):$("#hintText").replaceWith("<h5 id='hintText'>&emsp;Hint: "+e.hint+"</h5>")}),$("#hintBtn").on("click",function(){socket.emit("showHint",{id:socket.id})}),$("#skipBtn").on("click",function(){socket.emit("skip")}),SIGNIN_BG_COLOUR="#72145d",LOBBY_BG_COLOUR="#cc4f6e",DRAW_BG_COLOUR="#303d63",$("#draw-tab").on("click",()=>{joinedRoom&&loggedIn&&gotoDraw()}),$("#lobby-tab").on("click",()=>{loggedIn&&gotoLobby()}),$("#logout-btn").on("click",()=>{location.reload()});